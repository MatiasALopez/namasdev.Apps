@using namasdev.Apps.Entidades.Valores;
@using namasdev.Apps.Web.Portal.Helpers;
@model namasdev.Apps.Entidades.Entidad
@{
    // TODO (ML): continuar aca
    string namespaceBase = Model.AplicacionVersion.Aplicacion.Nombre;
    var clases = new
    {
        Entidad = Model.Nombre,
        Negocio = string.Format("{0}Business", Model.NombrePlural),
        Repositorio = string.Format("{0}Repository", Model.NombrePlural),
        Metadata = string.Format("{0}Metadata", Model.Nombre),
        MetadataPropiedades = string.Format("{0}Metadata.Propiedades", Model.Nombre),
        AgregarParametros = "AddParameters",
        ActualizarParametros = "UpdateParameter",
        MarcarComoBorradoParametros = "SetAsDeletedParameter",
        DesmarcarComoBorradoParametros = "UnsetAsDeletedParameter",
        EliminarParametros = "DeleteParameter"
    };
    var interfaces = new
    {
        Negocio = string.Format("I{0}", clases.Negocio),
        Repositorio = string.Format("I{0}", clases.Repositorio)
    };
    var variables = new
    {
        Repositorio = "repository",
        ErroresNegocio = "errorsBusiness",
        Mapper = "mapper",
        Parametros = "parameters",
        Entidad = "entity",
        UsuarioId = "userId",
    };
    var parametros = new
    {
        Entidad = "entity",
        Parametros = "parameters",
        Errores = "errors",
        Requerido = "required",
        TamañoMinimo = "minLength",
        TamañoMaximo = "maxLength",
        TamañoExacto = "exactLength",
        ValorMaximo = "maxValue",
        ValorMinimo = "minValue",
        CantDecimales = "decimalCount",
        RegEx = "regEx"
    };
    var validaciones = new List<string>();
    string validacionMetodo,
        propiedadNombre;
    Dictionary<string, string> validacionParametros;
    foreach (var p in Model.Propiedades)
    {
        validacionMetodo = null;
        propiedadNombre = p.NombreOId;
        validacionParametros = new Dictionary<string, string>();
        switch (p.PropiedadTipoId)
        {
            case PropiedadTipos.TEXTO:
                validacionMetodo = "ValidateStringAndAddToErrorList";
                if (p.EspecificacionesTexto.TamañoExacto.HasValue)
                {
                    validacionParametros.Add(parametros.TamañoExacto, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MAX));
                }
                else
                {
                    if (p.EspecificacionesTexto.TamañoMinimo.HasValue)
                    {
                        validacionParametros.Add(parametros.TamañoMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MIN));
                    }
                    if (p.EspecificacionesTexto.TamañoMaximo.HasValue)
                    {
                        validacionParametros.Add(parametros.TamañoMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MAX));
                    }
                }
                if (!string.IsNullOrWhiteSpace(p.EspecificacionesTexto.RegEx))
                {
                    validacionParametros.Add(parametros.RegEx, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.REG_EX));
                }
                break;
            case PropiedadTipos.ENTERO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEntero.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEntero.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.ENTERO_CORTO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEnteroCorto.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEnteroCorto.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.ENTERO_LARGO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEnteroLargo.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEnteroLargo.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.DECIMAL:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                validacionParametros.Add(parametros.CantDecimales, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                break;
            case PropiedadTipos.DECIMAL_FLOTANTE:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                validacionParametros.Add(parametros.CantDecimales, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                break;
        }
        if (!string.IsNullOrWhiteSpace(validacionMetodo))
        {
            validaciones.Add(string.Format("Validator.{0}({1}.{2}, {3}.{2}.{4}, {5}: {6}, {7}{8})",
                validacionMetodo,
                parametros.Entidad,
                propiedadNombre,
                clases.MetadataPropiedades,
                EntidadMetadataAtributos_en.ETIQUETA,
                parametros.Requerido,
                (!p.PermiteNull).ToString().ToLower(),
                parametros.Errores,
                validacionParametros.Count > 0 ? ", " + FormatoHelper.ListaParametrosValores(validacionParametros) : ""));
        }
    }
}
using System;
using System.Collections.Generic;

using AutoMapper;
using namasdev.Core.Entity;
using namasdev.Core.Validation;

using @(Html.Raw(namespaceBase)).Data;
using @(Html.Raw(namespaceBase)).Entities;
using @(Html.Raw(namespaceBase)).Entities.Metadata;
using @(Html.Raw(namespaceBase)).Business.DTO.@(Html.Raw(Model.NombrePlural));

namespace @(Html.Raw(namespaceBase)).Business
{
    public interface @Html.Raw(interfaces.Negocio)
    {
        @if (!Model.Especificaciones.EsSoloLectura)
        {
        <text>@Html.Raw(clases.Entidad) Add(@clases.AgregarParametros @parametros.Parametros);
        void Update(@clases.ActualizarParametros @parametros.Parametros);</text>
        }
        @if (Model.Especificaciones.BajaTipoId == BajaTipos.LOGICA)
        {
        <text>void SetAsDeleted(@clases.MarcarComoBorradoParametros @parametros.Parametros);
        void UnsetAsDeleted(@clases.DesmarcarComoBorradoParametros @parametros.Parametros);</text>
        }
        else if (Model.Especificaciones.BajaTipoId == BajaTipos.FISICA)
        { 
        <text>void Eliminar(@clases.EliminarParametros @parametros.Parametros);</text>
        }
    }

    public class @Html.Raw(clases.Negocio) : @Html.Raw(FormatoHelper.Generic("NegocioBase", interfaces.Repositorio)), @Html.Raw(interfaces.Negocio)
    {
        public @(Html.Raw(clases.Negocio))(@Html.Raw(interfaces.Repositorio) @Html.Raw(variables.Repositorio), IErroresNegocio @variables.ErroresNegocio, IMapper @variables.Mapper)
            : base(@Html.Raw(variables.Repositorio), @variables.ErroresNegocio, @variables.Mapper)
        {
        }

        @if (!Model.Especificaciones.EsSoloLectura)
        {<text>
        public @Html.Raw(clases.Entidad) Agregar(@clases.AgregarParametros @variables.Parametros)
        {
            Validador.ValidarArgumentRequeridoYThrow(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            @if (Model.Especificaciones.IDPropiedadTipoId == PropiedadTipos.GUID)
            {
            <text>@(Html.Raw(variables.Entidad)).Id = Guid.NewGuid();
            </text>
            }
            @if (Model.Especificaciones.AuditoriaCreado || Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            DateTime fechaHora = DateTime.Now;</text>}
            @if (Model.Especificaciones.AuditoriaCreado)
            {
            <text>
            @(Html.Raw(variables.Entidad)).EstablecerDatosCreado(@(variables.Parametros).UsuarioLogueadoId, fechaHora);</text>}
            @if (Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            @(Html.Raw(variables.Entidad)).EstablecerDatosModificacion(@(variables.Parametros).UsuarioLogueadoId, fechaHora);
            </text>}
    
            ValidarDatos(@Html.Raw(variables.Entidad));

            Repositorio.Agregar(@Html.Raw(variables.Entidad));

            return @Html.Raw(variables.Entidad);
        }

        public void Actualizar(@clases.ActualizarParametros @variables.Parametros)
        {
            Validador.ValidarArgumentRequeridoYThrow(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = Obtener(@(variables.Parametros).Id);
            Mapper.Map(@variables.Parametros, @Html.Raw(variables.Entidad));
            @if (Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            @(Html.Raw(variables.Entidad)).EstablecerDatosModificacion(@(variables.Parametros).UsuarioLogueadoId, DateTime.Now);
            </text>}

            ValidarDatos(@Html.Raw(variables.Entidad));

            Repositorio.Actualizar(@Html.Raw(variables.Entidad));
        }
        </text>}
        @if (Model.Especificaciones.BajaTipoId == BajaTipos.LOGICA)
        {<text>
        public void MarcarComoBorrado(@clases.MarcarComoBorradoParametros @variables.Parametros)
        {
            Validador.ValidarArgumentRequeridoYThrow(@variables.Parametros, nameof(@variables.Parametros));
    
            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            @(Html.Raw(variables.Entidad)).EstablecerDatosBorrado(@(variables.Parametros).UsuarioLogueadoId, DateTime.Now);

            ValidarDatos(@Html.Raw(variables.Entidad));

            Repositorio.ActualizarDatosBorrado(@Html.Raw(variables.Entidad));
        }

        public void DesmarcarComoBorrado(@clases.DesmarcarComoBorradoParametros @variables.Parametros)
        {
            Validador.ValidarArgumentRequeridoYThrow(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            Repositorio.ActualizarDatosBorrado(@Html.Raw(variables.Entidad));
        }
        </text>}
        else if (Model.Especificaciones.BajaTipoId == BajaTipos.FISICA) 
        {<text>
        public void Eliminar(@clases.EliminarParametros @variables.Parametros)
        {
            Validador.ValidarArgumentRequeridoYThrow(@variables.Parametros, nameof(@variables.Parametros));
    
            Repositorio.EliminarPorId(@(variables.Parametros).Id);
        }
        </text>}
        @if (!Model.Especificaciones.EsSoloLectura) 
        {<text> 
        private @Html.Raw(clases.Entidad) Obtener(@Model.Especificaciones.IDTipo.CLRType id,
            bool validarExistencia = true)
        {
            var entidad = Repositorio.Obtener(id);
            if (validarExistencia
                && entidad == null)
            {
                throw new Exception(Validador.MensajeEntidadInexistente(@(Html.Raw(clases.Metadata)).ETIQUETA, id));
            }

            return entidad;
        }

        private void ValidarDatos(@Html.Raw(clases.Entidad) entidad)
        {
            var errores = new @(Html.Raw(FormatoHelper.Generic("List", "string")))();

        @foreach (var v in validaciones)
        {
            <text>@Html.Raw(v);</text>
        }

            Validador.LanzarExcepcionMensajeAlUsuarioSiExistenErrores(errores);
        }
        </text>}
    }
}

