@using namasdev.Apps.Entidades.Valores;
@using namasdev.Apps.Web.Portal.Helpers;
@model namasdev.Apps.Entidades.Entidad
@{
    var idiomaTextos = Model.AplicacionVersion.Aplicacion.Idioma.Textos.Idioma.Textos;
    var namespaces = new 
    {
        Aplicacion = Model.AplicacionVersion.Aplicacion.Nombre,
        Entidades = idiomaTextos.EntidadesNombre,
        Datos = idiomaTextos.DatosNombre,
        Negocio = idiomaTextos.NegocioNombre,
    };
    var clases = new
    {
        Entidad = Model.Nombre,
        Negocio = string.Format("{0}{1}", Model.NombrePlural, idiomaTextos.NegocioNombre),
        Repositorio = string.Format("{0}{1}", Model.NombrePlural, idiomaTextos.Repositorio),
        Metadata = string.Format("{0}Metadata", Model.Nombre),
        MetadataPropiedades = string.Format("{0}Metadata.{1}", Model.Nombre, idiomaTextos.Propiedades),
        AgregarParametros = string.Format("{0}{1}", idiomaTextos.Agregar, idiomaTextos.Parametros),
        ActualizarParametros = string.Format("{0}{1}", idiomaTextos.Actualizar, idiomaTextos.Parametros),
        MarcarComoBorradoParametros = string.Format("{0}{1}", idiomaTextos.MarcarComoBorrado, idiomaTextos.Parametros),
        DesmarcarComoBorradoParametros = string.Format("{0}{1}", idiomaTextos.DesmarcarComoBorrado, idiomaTextos.Parametros),
        EliminarParametros = string.Format("{0}{1}", idiomaTextos.Eliminar, idiomaTextos.Parametros),
        Validador = "Validator",
    };
    var interfaces = new
    {
        Negocio = string.Format("I{0}", clases.Negocio),
        Repositorio = string.Format("I{0}", clases.Repositorio)
    };
    var variables = new
    {
        Parametros = "parameters",
        Entidad = "entity",
        UsuarioId = "userId",
        Errores = "errors",
        FechaHoraActual = "now",
    };
    var propiedades = new
    {
        Repositorio = idiomaTextos.Repositorio,
        UsuarioLogueadoId = "LoggedUserId",
    };
    var parametros = new
    {
        Repositorio = "repository",
        ErroresNegocio = "errorsBusiness",
        Mapper = "mapper",
        Entidad = "entity",
        Parametros = "parameters",
        Errores = "errors",
        Requerido = "required",
        TamañoMinimo = "minLength",
        TamañoMaximo = "maxLength",
        TamañoExacto = "exactLength",
        ValorMaximo = "maxValue",
        ValorMinimo = "minValue",
        CantDecimales = "decimalCount",
        RegEx = "regEx",
        ValidarExistencia = "ValidateExists",
    };
    var metodos = new
    {
        Agregar = idiomaTextos.Agregar,
        Actualizar = idiomaTextos.Actualizar,
        MarcarComoBorrado = idiomaTextos.MarcarComoBorrado,
        DesmarcarComoBorrado = idiomaTextos.DesmarcarComoBorrado,
        Eliminar = idiomaTextos.Eliminar,
        EliminarPorId = string.Format("{0}ById", idiomaTextos.Eliminar),
        Obtener = "Get",
        ValidarArgumentoRequerido = "ValidateRequiredArgumentAndThrow",
        ValidarEntidad = "ValidateEntity",
        EstablecerDatosCreado = "SetCreated",
        EstablecerDatosModificado = "SetModified",
        EstablecerDatosBorrado = "SetDeleted",
        ActualizarPropiedadesBorrado = "UpdateDeletedProperties",
    };
    var validaciones = new List<string>();
    string validacionMetodo,
        propiedadNombre;
    Dictionary<string, string> validacionParametros;
    foreach (var p in Model.Propiedades)
    {
        validacionMetodo = null;
        propiedadNombre = p.NombreOId;
        validacionParametros = new Dictionary<string, string>();
        switch (p.PropiedadTipoId)
        {
            case PropiedadTipos.TEXTO:
                validacionMetodo = "ValidateStringAndAddToErrorList";
                if (p.EspecificacionesTexto.TamañoExacto.HasValue)
                {
                    validacionParametros.Add(parametros.TamañoExacto, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MAX));
                }
                else
                {
                    if (p.EspecificacionesTexto.TamañoMinimo.HasValue)
                    {
                        validacionParametros.Add(parametros.TamañoMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MIN));
                    }
                    if (p.EspecificacionesTexto.TamañoMaximo.HasValue)
                    {
                        validacionParametros.Add(parametros.TamañoMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MAX));
                    }
                }
                if (!string.IsNullOrWhiteSpace(p.EspecificacionesTexto.RegEx))
                {
                    validacionParametros.Add(parametros.RegEx, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.REG_EX));
                }
                break;
            case PropiedadTipos.ENTERO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEntero.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEntero.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.ENTERO_CORTO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEnteroCorto.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEnteroCorto.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.ENTERO_LARGO:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                if (p.EspecificacionesEnteroLargo.ValorMinimo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                }
                if (p.EspecificacionesEnteroLargo.ValorMaximo.HasValue)
                {
                    validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                }
                break;
            case PropiedadTipos.DECIMAL:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                validacionParametros.Add(parametros.CantDecimales, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                break;
            case PropiedadTipos.DECIMAL_FLOTANTE:
                validacionMetodo = "ValidateNumberAndAddToErrorList";
                validacionParametros.Add(parametros.CantDecimales, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                validacionParametros.Add(parametros.ValorMinimo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                validacionParametros.Add(parametros.ValorMaximo, FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                break;
        }
        if (!string.IsNullOrWhiteSpace(validacionMetodo))
        {
            validaciones.Add(string.Format("{0}.{1}({2}.{3}, {4}.{3}.{5}, {6}: {7}, {8}{9})",
                clases.Validador,
                validacionMetodo,
                parametros.Entidad,
                propiedadNombre,
                clases.MetadataPropiedades,
                EntidadMetadataAtributos_en.ETIQUETA,
                parametros.Requerido,
                (!p.PermiteNull).ToString().ToLower(),
                parametros.Errores,
                validacionParametros.Count > 0 ? ", " + FormatoHelper.ListaParametrosValores(validacionParametros) : ""));
        }
    }
}
using System;
using System.Collections.Generic;

using AutoMapper;
using namasdev.Core.Entity;
using namasdev.Core.Validation;

using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades);
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades).Metadata;
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Datos);
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Negocio).DTO.@(Html.Raw(Model.NombrePlural));

namespace @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Negocio)
{
    public interface @Html.Raw(interfaces.Negocio)
    {
    @if (!Model.Especificaciones.EsSoloLectura)
    {
        <text>@Html.Raw(clases.Entidad) @(metodos.Agregar)(@clases.AgregarParametros @parametros.Parametros);
        void @(metodos.Actualizar)(@clases.ActualizarParametros @parametros.Parametros);</text>
    }
    @if (Model.Especificaciones.BajaTipoId == BajaTipos.LOGICA)
    {
    <text>void @(metodos.MarcarComoBorrado)(@clases.MarcarComoBorradoParametros @parametros.Parametros);
        void @(metodos.DesmarcarComoBorrado)(@clases.DesmarcarComoBorradoParametros @parametros.Parametros);</text>
    }
    else if (Model.Especificaciones.BajaTipoId == BajaTipos.FISICA)
    {
    <text>void @(metodos.Eliminar)(@clases.EliminarParametros @parametros.Parametros);</text>
    }
    }

    public class @Html.Raw(clases.Negocio) : @Html.Raw(FormatoHelper.Generic("BusinessBase", interfaces.Repositorio)), @Html.Raw(interfaces.Negocio)
    {
        public @(Html.Raw(clases.Negocio))(@Html.Raw(interfaces.Repositorio) @Html.Raw(parametros.Repositorio), IErrorsBusiness @parametros.ErroresNegocio, IMapper @parametros.Mapper)
            : base(@Html.Raw(parametros.Repositorio), @parametros.ErroresNegocio, @parametros.Mapper)
        {
        }

        @if (!Model.Especificaciones.EsSoloLectura)
        {<text>
        public @Html.Raw(clases.Entidad) @(metodos.Agregar)(@clases.AgregarParametros @variables.Parametros)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            @if (Model.Especificaciones.IDPropiedadTipoId == PropiedadTipos.GUID)
            {
            <text>@(Html.Raw(variables.Entidad)).Id = Guid.NewGuid();
                </text>
            }
            @if (Model.Especificaciones.AuditoriaCreado || Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            DateTime @variables.FechaHoraActual = DateTime.Now;</text>}
            @if (Model.Especificaciones.AuditoriaCreado)
            {
            <text>
            @(Html.Raw(variables.Entidad)).@(metodos.EstablecerDatosCreado)(@(variables.Parametros).@(propiedades.UsuarioLogueadoId), @variables.FechaHoraActual);</text>}
            @if (Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            @(Html.Raw(variables.Entidad)).@(metodos.EstablecerDatosModificado)(@(variables.Parametros).@(propiedades.UsuarioLogueadoId), @variables.FechaHoraActual);
            </text>}

            @(metodos.ValidarEntidad)(@Html.Raw(variables.Entidad));

            @(propiedades.Repositorio).@(metodos.Agregar)(@Html.Raw(variables.Entidad));

            return @Html.Raw(variables.Entidad);
        }

        public void @(metodos.Actualizar)(@clases.ActualizarParametros @variables.Parametros)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(metodos.Obtener)(@(variables.Parametros).Id);
            Mapper.Map(@variables.Parametros, @Html.Raw(variables.Entidad));
            @if (Model.Especificaciones.AuditoriaUltimaModificacion)
            {
            <text>
            @(Html.Raw(variables.Entidad)).@(metodos.EstablecerDatosModificado)(@(variables.Parametros).@(propiedades.UsuarioLogueadoId), DateTime.Now);
            </text>}

            @(metodos.ValidarEntidad)(@Html.Raw(variables.Entidad));

            @(propiedades.Repositorio).@(metodos.Actualizar)(@Html.Raw(variables.Entidad));
        }
        </text>}
        @if (Model.Especificaciones.BajaTipoId == BajaTipos.LOGICA)
        {<text>
        public void @(metodos.MarcarComoBorrado)(@clases.MarcarComoBorradoParametros @variables.Parametros)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            @(Html.Raw(variables.Entidad)).@(metodos.EstablecerDatosBorrado)(@(variables.Parametros).@(propiedades.UsuarioLogueadoId), DateTime.Now);

            @(metodos.ValidarEntidad)(@Html.Raw(variables.Entidad));

            @(propiedades.Repositorio).@(metodos.ActualizarPropiedadesBorrado)(@Html.Raw(variables.Entidad));
        }

        public void @(metodos.DesmarcarComoBorrado)(@clases.DesmarcarComoBorradoParametros @variables.Parametros)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@variables.Parametros, nameof(@variables.Parametros));

            var @Html.Raw(variables.Entidad) = @(Html.Raw(FormatoHelper.Generic("Mapper.Map", clases.Entidad)))(@variables.Parametros);
            @(propiedades.Repositorio).@(metodos.ActualizarPropiedadesBorrado)(@Html.Raw(variables.Entidad));
        }
        </text>}
        else if (Model.Especificaciones.BajaTipoId == BajaTipos.FISICA)
        {<text>
        public void @(metodos.Eliminar)(@clases.EliminarParametros @variables.Parametros)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@variables.Parametros, nameof(@variables.Parametros));

            @(propiedades.Repositorio).@(metodos.EliminarPorId)(@(variables.Parametros).Id);
        }
        </text>}
        @if (!Model.Especificaciones.EsSoloLectura)
        {<text>
        private @Html.Raw(clases.Entidad) @(metodos.Obtener)(@Model.Especificaciones.IDTipo.CLRType id,
            bool @parametros.ValidarExistencia = true)
        {
            var @variables.Entidad = @(propiedades.Repositorio).@(metodos.Obtener)(id);
            if (@parametros.ValidarExistencia
                && @variables.Entidad == null)
            {
                throw new Exception(@(clases.Validador).Messages.EntityNotFound(@(Html.Raw(clases.Metadata)).LABEL, id));
            }

            return @variables.Entidad;
        }

        private void @(metodos.ValidarEntidad)(@Html.Raw(clases.Entidad) @variables.Entidad)
        {
            var @variables.Errores = new @(Html.Raw(FormatoHelper.Generic("List", "string")))();

            @foreach (var v in validaciones)
            {
            <text>@Html.Raw(v);</text>
            }

            @(clases.Validador).ThrowExceptionFriendlyMessageIfAnyErrors(@variables.Errores);
        }
</text>}
    }
}

