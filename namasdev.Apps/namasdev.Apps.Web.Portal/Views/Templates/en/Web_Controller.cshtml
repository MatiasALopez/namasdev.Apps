@using namasdev.Core.Types;
@using namasdev.Apps.Entidades.Valores;
@using namasdev.Apps.Web.Portal.Helpers;
@model namasdev.Apps.Entidades.Entidad
@{
    var idiomaTextos = Model.AplicacionVersion.Aplicacion.Idioma.Textos.Idioma.Textos;
    var namespaces = new
    {
        Aplicacion = Model.AplicacionVersion.Aplicacion.Nombre,
        Entidades = idiomaTextos.EntidadesNombre,
        Datos = idiomaTextos.DatosNombre,
        Negocio = idiomaTextos.NegocioNombre,
        WebPortal = "Web.Portal",
    };
    var clases = new
    {
        Metadata = string.Format("{0}Metadata", Model.Nombre),
        MetadataMensajes = string.Format("{0}Metadata.Messages", Model.Nombre),
        Negocio = string.Format("{0}{1}", Model.NombrePlural, idiomaTextos.NegocioNombre),
        Repositorio = string.Format("{0}{1}", Model.NombrePlural, idiomaTextos.Repositorio),
        Controller = string.Format("{0}Controller", Model.NombrePlural),
        EntidadItemModel = string.Format("{0}ItemModel", Model.Nombre),
        ListaViewModel = string.Format("{0}ViewModel", Model.NombrePlural),
        EntidadViewModel = string.Format("{0}ViewModel", Model.Nombre),
        Views = string.Format("{0}Views", Model.NombrePlural),
        Validador = "Validator",
        AgregarParametros = string.Format("{0}{1}",idiomaTextos.Agregar, idiomaTextos.Parametros),
        ActualizarParametros = string.Format("{0}{1}",idiomaTextos.Actualizar, idiomaTextos.Parametros),
        MarcarComoBorradoParametros = string.Format("{0}{1}", idiomaTextos.MarcarComoBorrado, idiomaTextos.Parametros),
        EliminarParametros = string.Format("{0}{1}", idiomaTextos.Eliminar, idiomaTextos.Parametros),
        PaginaModo = "PageMode",
        ListasHelper = "ListHelper",
    };
    var interfaces = new
    {
        Negocio = string.Format("I{0}", clases.Negocio),
        Repositorio = string.Format("I{0}", clases.Repositorio)
    };
    var variables = new
    {
        Repositorio = clases.Repositorio.ToFirstLetterLowercase(),
        Negocio = clases.Negocio.ToFirstLetterLowercase(),
        Entidad = Model.Nombre.ToFirstLetterLowercase(),
        ViewModel = "model",
    };
    var propiedades = new
    {
        Pagina = "Page",
        Orden = "Order",
        UsuarioId = "UserId",
        UsuarioLogueadoId = "LoggedUserId",
        PaginaModo = "PageMode",
    };
    var constantes = new
    {
        ViewsEntidad = string.Format("{0}.{1}", clases.Views, Model.Nombre),
    };
    var metodos = new
    {
        Agregar = idiomaTextos.Agregar,
        Actualizar = idiomaTextos.Actualizar,
        MarcarComoBorrado = idiomaTextos.MarcarComoBorrado,
        DesmarcarComoBorrado = idiomaTextos.DesmarcarComoBorrado,
        Eliminar = idiomaTextos.Eliminar,
        Obtener = "Get",
        Cargar = "Cargar",
        Mapear = "Map",
        ValidarArgumentoRequerido = "ValidateRequiredArgumentAndThrow",
        CargarMensajeError = "SetMessageError",
        CargarMensajeOk = "SetMessageSuccess",
    };
    var parametros = new
    {
        Orden = "order",
        Pagina = "page",
        PaginaModo = "pageMode",
    };
    var actionNombres = new
    {
        Index = "Index",
        Agregar = idiomaTextos.Agregar,
        Editar = "Edit",
        Eliminar = idiomaTextos.Eliminar,
        Cargar = "Load",
    };
    bool tienePropiedadesBoolean = false,
tienePropiedadesHora = false;
    foreach (var p in Model.Propiedades)
    {
        if (p.EsCalculada || p.EsAuditoria) { continue; }
        if (p.PropiedadTipoId == PropiedadTipos.BOOLEANO) { tienePropiedadesBoolean = true; }
        else if (p.PropiedadTipoId == PropiedadTipos.FECHA_HORA || p.PropiedadTipoId == PropiedadTipos.HORA) { tienePropiedadesHora = true; }
    }
}
using System;
using System.Collections.Generic;
using System.Web.Mvc;

using AutoMapper;
using namasdev.Core.Validation;
using namasdev.Web.Helpers;
using namasdev.Web.Models;

using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades);
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades).Metadata;
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades).Values;
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Datos);
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Negocio);
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Negocio).DTO.@(Html.Raw(Model.NombrePlural));
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).Metadata.Views;
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).Models.@(Html.Raw(Model.NombrePlural));
using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).ViewModels.@(Html.Raw(Model.NombrePlural));

/* TODO (Gen):
 * - [App_Start/Startup_DI] Register repository, business and controller
 * - [Views/Shared/_Menu] (optional) Add menu item(s)
 */
namespace @(Html.Raw(namespaces.Aplicacion)).Web.Portal.Controllers
{
    [Authorize(Roles = AspNetRoles.ADMINISTRATOR)]
    public class @Html.Raw(clases.Controller) : ControllerBase
    {
        public const string NAME = "@Model.NombrePlural";

        private readonly @Html.Raw(interfaces.Repositorio) _@Html.Raw(variables.Repositorio);
        private readonly @Html.Raw(interfaces.Negocio) _@Html.Raw(variables.Negocio);

        public @(Html.Raw(clases.Controller))(@Html.Raw(interfaces.Repositorio) @Html.Raw(variables.Repositorio), @Html.Raw(interfaces.Negocio) @Html.Raw(variables.Negocio), IMapper mapper)
            : base(mapper)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@Html.Raw(variables.Repositorio), nameof(@Html.Raw(variables.Repositorio)));
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@Html.Raw(variables.Negocio), nameof(@Html.Raw(variables.Negocio)));

            _@Html.Raw(variables.Repositorio) = @Html.Raw(variables.Repositorio);
            _@Html.Raw(variables.Negocio) = @Html.Raw(variables.Negocio);
        }

        #region Actions

        public ActionResult @(actionNombres.Index)(
            int @(parametros.Pagina) = 1,
            string @(parametros.Orden) = null)
        {
            var @Html.Raw(variables.ViewModel) = new @Html.Raw(clases.ListaViewModel)
            {
                @propiedades.Pagina = @(parametros.Pagina),
                @propiedades.Orden = @(parametros.Orden),
            };

            @(metodos.Cargar)@(Html.Raw(clases.ListaViewModel))(@Html.Raw(variables.ViewModel));
            return View(@Html.Raw(variables.ViewModel));
        }
        @if (Model.Especificaciones.BajaTipoId != BajaTipos.NINGUNA)
        {
        <text>
        [HttpPost,
        ValidateAntiForgeryToken]
        public ActionResult @(metodos.Eliminar)(@Model.Especificaciones.IDTipo.CLRType id)
        {
            var @Html.Raw(variables.Entidad) = _@(Html.Raw(variables.Repositorio)).@(metodos.Obtener)(id);
            if (@Html.Raw(variables.Entidad) == null)
            {
                return Json(new { success = false, message = @(clases.Validador).Messages.EntityNotFound(@(Html.Raw(clases.Metadata)).LABEL, id) });
            }

            try
            {
                @if (Model.Especificaciones.BajaTipoId == BajaTipos.LOGICA)
                {
                <text>_@(Html.Raw(variables.Negocio)).@(metodos.MarcarComoBorrado)(
                    new @(clases.MarcarComoBorradoParametros) 
                    { 
                        Id = id, 
                        @propiedades.UsuarioLogueadoId = @propiedades.UsuarioId, 
                    });</text>
                }
                else
                {
                <text>_@(Html.Raw(variables.Negocio)).@(metodos.Eliminar)(
                    new @clases.EliminarParametros 
                    { 
                        Id = id, 
                        @propiedades.UsuarioLogueadoId = @propiedades.UsuarioId 
                    });</text>
                }
            }
            catch (Exception)
            {
                return Json(new { success = false, message = @(Html.Raw(clases.MetadataMensajes)).DELETE_ERROR });
            }

            return Json(new { success = true });
        }</text>
        }
        @if (!Model.Especificaciones.EsSoloLectura)
        {
        <text>
        public ActionResult @(actionNombres.Agregar)()
        {
            var @Html.Raw(variables.ViewModel) = new @(Html.Raw(clases.EntidadViewModel))();
            @(metodos.Cargar)@(Html.Raw(clases.EntidadViewModel))(@Html.Raw(variables.ViewModel), @(clases.PaginaModo).@(actionNombres.Agregar));

            return View(@Html.Raw(constantes.ViewsEntidad), @Html.Raw(variables.ViewModel));
        }

        [HttpPost,
        ValidateAntiForgeryToken]
        public ActionResult @(actionNombres.Agregar)(@Html.Raw(clases.EntidadViewModel) @Html.Raw(variables.ViewModel))
        {
            try
            {
                if (ModelState.IsValid)
                {
                    _@(Html.Raw(variables.Negocio)).@(metodos.Agregar)(@(Html.Raw(FormatoHelper.Generic(metodos.Mapear, clases.AgregarParametros)))(@Html.Raw(variables.ViewModel)));

                    return RedirectToAction(nameof(@(actionNombres.Index)));
                }
            }
            catch (Exception ex)
            {
                ControllerHelper.@(metodos.CargarMensajeError)(ex.Message);
            }

            @(metodos.Cargar)@(Html.Raw(clases.EntidadViewModel))(@Html.Raw(variables.ViewModel), @(clases.PaginaModo).@(actionNombres.Agregar));
            return View(@Html.Raw(constantes.ViewsEntidad), @Html.Raw(variables.ViewModel));
        }

        public ActionResult @(actionNombres.Editar)(@Model.Especificaciones.IDTipo.CLRType id)
        {
            var @Html.Raw(variables.Entidad) = _@(Html.Raw(variables.Repositorio)).@(metodos.Obtener)(id);
            if (@Html.Raw(variables.Entidad) == null)
            {
                return RedirectToAction(nameof(@actionNombres.Index));
            }

            var @Html.Raw(variables.ViewModel) = @(Html.Raw(FormatoHelper.Generic(metodos.Mapear, clases.EntidadViewModel)))(@Html.Raw(variables.Entidad));
            @(metodos.Cargar)@(Html.Raw(clases.EntidadViewModel))(@Html.Raw(variables.ViewModel), @(clases.PaginaModo).@(actionNombres.Editar));

            return View(@Html.Raw(constantes.ViewsEntidad), @Html.Raw(variables.ViewModel));
        }

        [HttpPost,
        ValidateAntiForgeryToken]
        public ActionResult @(actionNombres.Editar)(@Html.Raw(clases.EntidadViewModel) @Html.Raw(variables.ViewModel))
        {
            try
            {
                if (ModelState.IsValid)
                {
                    _@(Html.Raw(variables.Negocio)).@(metodos.Actualizar)(@(Html.Raw(FormatoHelper.Generic(metodos.Mapear, clases.ActualizarParametros)))(@Html.Raw(variables.ViewModel)));

                    ControllerHelper.@(metodos.CargarMensajeOk)(@(Html.Raw(clases.MetadataMensajes)).UPDATE_OK);
                }
            }
            catch (Exception ex)
            {
                ControllerHelper.@(metodos.CargarMensajeError)(ex.Message);
            }

            @(metodos.Cargar)@(Html.Raw(clases.EntidadViewModel))(@Html.Raw(variables.ViewModel), @(clases.PaginaModo).@(actionNombres.Editar));

            return View(@Html.Raw(constantes.ViewsEntidad), @Html.Raw(variables.ViewModel));
        }</text>
        }

        #endregion Actions

        #region Methods

        private void @(metodos.Cargar)@(Html.Raw(clases.ListaViewModel))(@Html.Raw(clases.ListaViewModel) @Html.Raw(variables.ViewModel))
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@Html.Raw(variables.ViewModel), nameof(@Html.Raw(variables.ViewModel)));

            var op = @(Html.Raw(variables.ViewModel)).CreateOrderAndPagingParameters();

            @(Html.Raw(variables.ViewModel)).Items = @(Html.Raw(FormatoHelper.Generic(metodos.Mapear, FormatoHelper.Generic("List", clases.EntidadItemModel))))(
                _@(Html.Raw(variables.Repositorio)).GetList(
                    //search: @(Html.Raw(variables.ViewModel)).Search,
                    op: op));

            @(Html.Raw(variables.ViewModel)).SetPagination(op);
        }
        @if (!Model.Especificaciones.EsSoloLectura)
        {
        <text>
        private void @(metodos.Cargar)@(Html.Raw(clases.EntidadViewModel))(@Html.Raw(clases.EntidadViewModel) @Html.Raw(variables.ViewModel), @(clases.PaginaModo) @parametros.PaginaModo)
        {
            @(clases.Validador).@(metodos.ValidarArgumentoRequerido)(@Html.Raw(variables.ViewModel), nameof(@Html.Raw(variables.ViewModel)));

            @(Html.Raw(variables.ViewModel)).@(propiedades.PaginaModo) = @parametros.PaginaModo;

@if (tienePropiedadesBoolean) {
            <text>@(Html.Raw(variables.ViewModel)).YesNoSelectList = @(clases.ListasHelper).GetYesNoSelectList();</text>
}
@if (tienePropiedadesHora) {
            <text>@(Html.Raw(variables.ViewModel)).TimeSelectList = @(clases.ListasHelper).GetTimeSelectList();</text>
}
        }</text>
        }

        #endregion Methods
    }
}
