@using namasdev.Core.Types;
@using namasdev.Apps.Entidades.Valores;
@using namasdev.Apps.Web.Portal.Helpers;
@model namasdev.Apps.Entidades.Entidad
@{
    var idiomaTextos = Model.AplicacionVersion.Aplicacion.Idioma.Textos.Idioma.Textos;
    var namespaces = new
    {
        Aplicacion = Model.AplicacionVersion.Aplicacion.Nombre,
        Entidades = idiomaTextos.EntidadesNombre,
        WebPortal = "Web.Portal",
    };
    var clases = new
    {
        Entidad = Model.Nombre,
        Metadata = string.Format("{0}Metadata", Model.Nombre),
        EntidadViewModel = string.Format("{0}ViewModel", Model.Nombre),
        Controller = string.Format("{0}Controller", Model.NombrePlural),
    };
    var variables = new
    {
        ControlesIds = "controlsIds",
    };
    var formatos = new
    {
        Fecha = "{0:dd/MM/yyyy}",
    };
    var javaScript = new
    {
        App = Model.AplicacionVersion.Aplicacion.Nombre.Replace(".", ""),
    };
    bool tieneID = Model.Especificaciones.IDPropiedadTipoId.HasValue,
        propiedadEsImporte;
    string controlTipo;
    List<string> controlCssClasses;
    List<string> controlAdditionalParameters;
    Dictionary<string, string> labelHtmlAttributes,
        controlHtmlAttributes;
}
@@using namasdev.Core.Types;
@@using namasdev.Web.Helpers;
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades);
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades).Metadata;
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).Controllers;
@@model @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).ViewModels.@(Html.Raw(Model.NombrePlural)).@(Html.Raw(clases.EntidadViewModel))
@@{
    ViewBag.Title = $"{Model.PageMode} {@(Html.Raw(clases.Metadata)).LABEL}";

    var @variables.ControlesIds = new
    {
        Form = $"frm{@(Html.Raw(clases.Metadata)).NAME}"
    };
}
<h2 class="my-3">@ViewBag.Title</h2>
<form id="@string.Format("@{0}.Form", variables.ControlesIds)" action="@("@Url.Action()")" method="post" class="mt-3">
    @@Html.AntiForgeryToken()
    @@Html.ValidationSummary(excludePropertyErrors: true)
    @@Html.MessageSuccess()
    @@Html.MessageError()
    @if (tieneID)
    {
        <text>@@Html.HiddenFor(m => m.Id)</text>
    }
    @@Html.HiddenFor(m => m.PageMode)
    <div class="form-row">
        @foreach (var p in Model.Propiedades)
        {
            if (p.EsCalculada || p.EsID || p.EsAuditoria)
            {
                continue;
            }
            labelHtmlAttributes = new Dictionary<string, string>();
            controlTipo = "TextBox";
            controlAdditionalParameters = new List<string>();
            controlCssClasses = new List<string> { "form-control" };
            controlHtmlAttributes = new Dictionary<string, string>();
            propiedadEsImporte = false;
            if (!p.PermiteNull)
            {
                labelHtmlAttributes.Add("class", FormatoHelper.EntreComillas("required"));
                controlCssClasses.Add("form-control-required");
            }
            switch (p.PropiedadTipoId)
            {
                case PropiedadTipos.TEXTO:
                    if (p.EspecificacionesTexto != null)
                    {
                        if (p.EspecificacionesTexto.EsMultilinea)
                        {
                            controlTipo = "TextArea";
                        }
                        if (p.EspecificacionesTexto.TamañoMaximo.HasValue
                            || p.EspecificacionesTexto.TamañoExacto.HasValue)
                        {
                            controlHtmlAttributes.Add("maxlength", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.TAMAÑO_MAX));
                        }
                    }
                    break;
                case PropiedadTipos.ENTERO:
                    controlCssClasses.Add("inputmask-integer");
                    controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                    controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                    break;
                case PropiedadTipos.ENTERO_CORTO:
                    controlCssClasses.Add("inputmask-integer");
                    controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                    controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                    break;
                case PropiedadTipos.ENTERO_LARGO:
                    controlCssClasses.Add("inputmask-integer");
                    if (p.EspecificacionesEnteroLargo != null)
                    {
                        if (p.EspecificacionesEnteroLargo.ValorMinimo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                        }
                        if (p.EspecificacionesEnteroLargo.ValorMaximo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                        }
                    }
                    break;
                case PropiedadTipos.DECIMAL:
                    controlCssClasses.Add("inputmask-numeric");
                    controlHtmlAttributes.Add("data_inputmask_digits", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                    if (p.EspecificacionesDecimal != null)
                    {
                        if (p.EspecificacionesDecimal.ValorMinimo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                        }
                        if (p.EspecificacionesDecimal.ValorMinimo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                        }
                    }
                    break;
                case PropiedadTipos.DECIMAL_FLOTANTE:
                    controlCssClasses.Add("inputmask-numeric");
                    controlHtmlAttributes.Add("data_inputmask_digits", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                    if (p.EspecificacionesDecimalFlotante != null)
                    {
                        if (p.EspecificacionesDecimalFlotante.ValorMinimo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                        }
                        if (p.EspecificacionesDecimalFlotante.ValorMaximo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                        }
                    }
                    break;
                case PropiedadTipos.IMPORTE:
                    propiedadEsImporte = true;
                    controlCssClasses.Add("inputmask-numeric");
                    controlHtmlAttributes.Add("data_inputmask_digits", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.DIGITOS_DECIMALES));
                    if (p.EspecificacionesImporte != null)
                    {
                        if (p.EspecificacionesImporte.ValorMinimo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_min", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MINIMO));
                        }
                        if (p.EspecificacionesImporte.ValorMaximo.HasValue)
                        {
                            controlHtmlAttributes.Add("data_inputmask_max", FormatoHelper.MetadataPropiedadAtributo(p, EntidadMetadataAtributos_en.VALOR_MAXIMO));
                        }
                    }
                    break;
                case PropiedadTipos.FECHA_HORA:
                    controlAdditionalParameters = new List<string> { FormatoHelper.EntreComillas(formatos.Fecha) };
                    controlCssClasses.Add("datepicker");
                    break;
                case PropiedadTipos.FECHA:
                    controlAdditionalParameters = new List<string> { FormatoHelper.EntreComillas(formatos.Fecha) };
                    controlCssClasses.Add("datepicker");
                    break;
                case PropiedadTipos.HORA:
                    controlTipo = "DropDownList";
                    controlAdditionalParameters = new List<string> { "Model.TimeSelectList", FormatoHelper.EntreComillas("") };
                    break;
                case PropiedadTipos.BOOLEANO:
                    controlTipo = "DropDownList";
                    controlAdditionalParameters = new List<string> { "Model.YesNoSelectList", FormatoHelper.EntreComillas("") };
                    break;
            }
            controlHtmlAttributes.Add("class", FormatoHelper.EntreComillas(Formateador.Lista(controlCssClasses, separador: " ")));
            <div class="form-group col-md-6">
                @@Html.LabelFor(m => m.@(Html.Raw(p.NombreOId))@(Html.Raw(FormatoHelper.AtributosHtmlString(labelHtmlAttributes))))
                @if (propiedadEsImporte) {
                <text>@Html.Raw("<div class=\"input-group\"><div class=\"input-group-prepend\"><span class=\"input-group-text\">$</span></div>")
    </text>}
                @@Html.@(controlTipo)For(m => m.@(Html.Raw(p.NombreOId))@Html.Raw(controlAdditionalParameters.Count > 0 ? ", " + Formateador.Lista(controlAdditionalParameters) : "")@(Html.Raw(FormatoHelper.AtributosHtmlString(controlHtmlAttributes))))
                @if (propiedadEsImporte) {
                <text>@Html.Raw("</div>")
</text>}
                @@Html.ValidationMessageFor(m => m.@(Html.Raw(p.NombreOId)))
            </div>
        }
    </div>
    <button type="submit" class="btn btn-primary" data-toggle-state-container="#@string.Format("@{0}.Form", variables.ControlesIds)">Save</button>
    <a href="@(Html.Raw(string.Format("@Url.Action(nameof({0}.Index))", clases.Controller)))" class="btn btn-secondary">Back</a>
</form>
@@section bodyScripts {
<script type="text/javascript">
    $(function () {
        @(javaScript.App).setActiveMenuOption('@Html.Raw(Model.NombrePlural.ToFirstLetterLowercase())');
    });
</script>
}
