@using namasdev.Core.Types;
@using namasdev.Apps.Entidades.Valores;
@model namasdev.Apps.Entidades.Entidad
@{
    var namespaces = new
    {
        Aplicacion = Model.AplicacionVersion.Aplicacion.Nombre,
        Entidades = "Entities",
        WebPortal = "Web.Portal",
    };
    var clases = new
    {
        Entidad = Model.Nombre,
        Metadata = string.Format("{0}Metadata", Model.Nombre),
        MetadataMensajes = string.Format("{0}Metadata.Messages", Model.Nombre),
        ItemModel = string.Format("{0}ItemModel", Model.Nombre),
        ListaViewModel = string.Format("{0}ViewModel", Model.NombrePlural),
        Controller = string.Format("{0}Controller", Model.NombrePlural),
        Formateador = "Formatter",
    };
    var variables = new
    {
        ControlesIds = "controlsIds",
    };
    var javaScript = new
    {
        App = Model.AplicacionVersion.Aplicacion.Nombre.Replace(".",""),
    };
    string propiedadIdNombre = null;
    var propiedades = new Dictionary<string, string>();
    foreach (var p in Model.Propiedades)
    {
        if (p.EsCalculada || p.EsAuditoria)
        {
            continue;
        }
        if (p.EsID)
        {
            propiedadIdNombre = p.NombreOId;
            continue;
        }
        switch (p.PropiedadTipoId)
        {
            case PropiedadTipos.ENTERO:
            case PropiedadTipos.ENTERO_CORTO:
            case PropiedadTipos.ENTERO_LARGO:
                propiedades.Add(p.NombreOId, string.Format("{0}.Number(item.{1})", clases.Formateador, p.NombreOId));
                break;
            case PropiedadTipos.DECIMAL:
                propiedades.Add(p.NombreOId, string.Format("{0}.Number(item.{1}, decimalDigits: {2})", clases.Formateador, p.NombreOId, p.EspecificacionesDecimal.DigitosDecimales));
                break;
            case PropiedadTipos.DECIMAL_FLOTANTE:
                propiedades.Add(p.NombreOId, string.Format("{0}.Number(item.{1}, decimalDigits: {2})", clases.Formateador, p.NombreOId, p.EspecificacionesDecimalFlotante.DigitosDecimales));
                break;
            case PropiedadTipos.IMPORTE:
                propiedades.Add(p.NombreOId, string.Format("{0}.Amount(item.{1}, decimalDigits: 2)", clases.Formateador, p.NombreOId));
                break;
            case PropiedadTipos.FECHA_HORA:
                propiedades.Add(p.NombreOId, string.Format("{0}.DateTime(item.{2})", clases.Formateador, p.NombreOId));
                break;
            case PropiedadTipos.FECHA:
                propiedades.Add(p.NombreOId, string.Format("{0}.Date(item.{1})", clases.Formateador, p.NombreOId));
                break;
            case PropiedadTipos.HORA:
                propiedades.Add(p.NombreOId, string.Format("{0}.Time(item.{1})", clases.Formateador, p.NombreOId));
                break;
            case PropiedadTipos.BOOLEANO:
                propiedades.Add(p.NombreOId, string.Format("{0}.YesNo(item.{1})", clases.Formateador, p.NombreOId));
                break;
            default:
                propiedades.Add(p.NombreOId, string.Format("item.{0}", p.NombreOId));
                break;
        }
    }
    bool esSoloLectura = Model.Especificaciones.EsSoloLectura,
        eliminarDisponible = Model.Especificaciones.BajaTipoId != BajaTipos.NINGUNA;
}
@@using namasdev.Core.Types;
@@using namasdev.Web.Helpers;
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades);
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.Entidades).Metadata;
@@using @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).Controllers;
@@model @(Html.Raw(namespaces.Aplicacion)).@(namespaces.WebPortal).ViewModels.@(Html.Raw(Model.NombrePlural)).@(Html.Raw(clases.ListaViewModel))
@@{
    ViewBag.Title = @(Html.Raw(clases.Metadata)).LABEL_PLURAL;

    var @variables.ControlesIds = new
    {
        Form = $"frm{@(Html.Raw(clases.Metadata)).NAME_PLURAL}",
        TableContainer = $"div{@(Html.Raw(clases.Metadata)).NAME_PLURAL}Container",
        Table = $"tbl{@(Html.Raw(clases.Metadata)).NAME_PLURAL}",
    };
    var displayNames = new
    {
        //Search = Html.DisplayNameWithoutEncodingFor(m => m.Search).ToString()
    };
    @if (!esSoloLectura) 
    {
    <text>var clasesCss = new
    {
        DeleteButton = "btn-delete"
    };</text>
    }
}
<h2 class="my-2">@@ViewBag.Title</h2>
@@Html.Partial("_ResultOk")
@@Html.Partial("_Errors")
<div class="row my-3">
    @if (!esSoloLectura)
    {
    <div class="col-md-3">
        <a href="@Html.Raw(string.Format("@Url.Action(nameof({0}.Add))", clases.Controller))" class="btn btn-primary">Add</a>
    </div>
    }
    <div class="col-md-@(!esSoloLectura ? "9" : "12") text-right filters">
        @@*@@using (Html.BeginForm(@Html.Raw(string.Format("nameof({0}.Index)", clases.Controller)), @(Html.Raw(clases.Controller)).NAME, FormMethod.Get, new { @@class = "form-inline pull-right" }))
        {
        @@Html.TextBoxFor(m => m.Search, new { @@class = "form-control ml-1", placeholder = displayNames.Search, title = displayNames.Search, data_toggle = "tooltip" })
        <button type="submit" class="btn btn-secondary ml-1">Search</button>
        }*@@
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        @@if (Model.ItemsAvailable)
        {
            <div id="@string.Format("@{0}.TableContainer",variables.ControlesIds)" class="table-responsive">
                <form id="@string.Format("@{0}.Form", variables.ControlesIds)">
                    @@Html.AntiForgeryToken()
                </form>
                <table id="@string.Format("@{0}.Table", variables.ControlesIds)" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                        @foreach (var p in propiedades)
                        {
                            <th><a href="@Html.Raw(string.Format("@UrlBuilder.BuildUrlWithOrder(Request.Url, nameof({0}.{1}))", clases.Entidad, p.Key))">@@Html.DisplayNameFor(m => m.Items[0].@(Html.Raw(p.Key))) <i class="fa fa-sort ml-2"></i></a></th>
                        }
                        @if (!esSoloLectura)
                        {   <th></th> 
                        }
                        </tr>
                    </thead>
                    <tbody>
                        @@foreach (var item in Model.Items)
                        {
                            <tr>
                            @foreach (var p in propiedades)
                            {
                                <td>@@Html.Raw(@Html.Raw(p.Value))</td>
                            }
                            @if (!esSoloLectura) 
                            {   <td class="text-center">
                                    <a href="@Html.Raw(string.Format("@Url.Action(nameof({0}.Edit), new {{ id = item.{1} }})", clases.Controller, propiedadIdNombre))" class="btn btn-sm btn-outline-secondary"><i class="fa fa-edit" data-toggle="tooltip" title="Edit"></i></a>
                                    @if (eliminarDisponible)
                                    {
                                    <button class="btn btn-sm btn-outline-danger @("@clasesCss.DeleteButton")" data-id="@Html.Raw(string.Format("@item.{0}", propiedadIdNombre))"><i data-toggle="tooltip" title="Delete" class="fa fa-trash"></i></button>
                                    }
                                </td>
                            }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @@Html.Partial("_Pager", Model.Pager)
        }
        else
        {
            <div class="alert alert-warning">No @@@(Html.Raw(clases.Metadata)).LABEL_PLURAL to display.</div>
        }
    </div>
</div>
@@section bodyScripts {
<script type="text/javascript">
    $(function () {
        @(javaScript.App).setActiveMenuOption('@Html.Raw(Model.NombrePlural.ToFirstLetterLowercase())');
        @if (eliminarDisponible) {
        <text>
        $('#@@@(variables.ControlesIds).Table')
            .on('click', '.@@clasesCss.DeleteButton', function (ev) {
                ev.preventDefault();

                var id = $(this).data('id');
                if (!id) {
                    return;
                }

                var options = {
                    showLoadingSelector: '#@@@(variables.ControlesIds).TableContainer',
                    confirm: true,
                    confirmTitle: 'Delete @@@(Html.Raw(clases.Metadata)).LABEL',
                    confirmMessage: '@@@(Html.Raw(clases.MetadataMensajes)).DELETE_CONFIRMATION'
                };
                @(javaScript.App).postJson(
                    '@@Url.Action(nameof(@(Html.Raw(clases.Controller)).Delete))/' + id,
                    nmd.ui.forms.createDataWithAntiForgeryToken('#@@@(variables.ControlesIds).Form'),
                    function (response) {
                        if (response.success) {
                            nmd.ui.controls.showSuccessModal(
                                '@@@(Html.Raw(clases.MetadataMensajes)).DELETE_OK',
                                function () {
                                    nmd.page.reloadPage();
                                });
                        }
                        else {
                            @(javaScript.App).showErrorModal(response.message);
                        }
                    },
                    options
                );

                return false;
            });</text>
        }
    });
</script>
}